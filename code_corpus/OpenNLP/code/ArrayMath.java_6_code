  public static double logSumOfExps(double[] x) {
    double max = max(x);
    double sum = 0.0;
    for (int i = 0; i < x.length; i++) {
      if (x[i] != Double.NEGATIVE_INFINITY)
        sum += Math.exp(x[i] - max);
    }
    return max + Math.log(sum);
  }

  public static double max(double[] x) {
    int maxIdx = maxIdx(x);
    return x[maxIdx];
  }

