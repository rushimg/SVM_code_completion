    def __exit__(self, type, value, traceback):
        if self._to_put or self._to_delete:
            # Flush anything that's left.
            self.flush()
        if self._unprocessed:
            # Finally, handle anything that wasn't processed.
            self.resend_unprocessed()
